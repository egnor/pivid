# Pivid play script JSON format

A "play script" is a [JSON object](https://www.json.org/json-en.html)
describing the content Pivid should display. Play script JSON may be sent to a
running [`pivid_server`](running.md#pivid_server) using the
[`/play` request](protocol.md#play-post---set-play-script-to-control-video-output),
or supplied as a file to [`pivid_play --script`](running.md#pivid_play).

A new play script may be sent to the server at any time. You choose
whether to send only short term "scene" instructions and update the script
as needed, or send entire long term sequences.

Play scripts may also include content preloading directives, anticipating
content updated scripts may use (see the
[architecture overview](architecture.md)).

## JSON format

Syntax notes:
* `Â«double angle bracketsÂ»` mark value placeholders (`ğ‘“(ğ‘¡)` indicates a
[time-variable value](#time-variable-values)).
* `â“ red question marks` indicate optional items
* `triple dots Â·Â·Â·` indicate repeated items
* anything else is verbatim

```yaml
{
  "zero_time": Â«timestamp baseline, default is server startÂ»,
  "main_loop_hz": Â«output timeline update frequency, default 30Â»,
  "main_buffer_time": Â«output timeline length in seconds, default 0.2Â»,
  "screens": {
    ğŸ” "Â«hardware connector, eg. HDMI-1Â»": {
    âœ³ï¸ "mode": [Â«video mode widthÂ», Â«heightÂ», Â«refresh rateÂ»], 
      "update_hz": Â«content update frequency, default is refresh rateÂ», 
      "layers": [
        ğŸ” {
       âœ³ï¸ "media": "Â«media file, relative to media rootÂ»",
          "play": Â«ğ‘“(ğ‘¡) seek position within media in seconds, default 0.0Â», 
          "buffer": Â«media readahead in seconds, default 0.2Â», 
          "from_xy": [
            Â«ğ‘“(ğ‘¡) source media clip box left, default 0Â»,
            Â«ğ‘“(ğ‘¡) source media clip box top, default 0Â»
          ],
                
          "from_size": [
            Â«ğ‘“(ğ‘¡) source media clip box width, default is media widthÂ»,
            Â«ğ‘“(ğ‘¡) source media clip box height, default is media heightÂ»
          ],
                
          "to_xy": [
            Â«ğ‘“(ğ‘¡) screen region left, default 0Â»,
            Â«ğ‘“(ğ‘¡) screen region top, default 0Â»
          ],
                
          "to_size": [
            Â«ğ‘“(ğ‘¡) screen region width, default is screen widthÂ»,
            Â«ğ‘“(ğ‘¡) screen region height, default is screen heightÂ»
          ],
                
          "opacity": Â«ğ‘“(ğ‘¡) alpha value, default 1.0Â» 
        }, 
      ]
    },
  }
  

  "media": {
      "Â«media file to configure, relative to media rootÂ»": {
        â“ "seek_scan_time": Â«threshold for seeking vs reading, default 1.0Â», 
        â“ "decoder_idle_time": Â«retention time for unused decoders, default 1.0Â», 
        â“ "preload": Â«preload specification, see belowÂ» 
      },
      Â·Â·Â·
    }
  
}
```

## General structure

## Time reference and `zero_time`

Pivid script timing is based on
[wall-clock Unix time](https://en.wikipedia.org/wiki/Unix_time).
(It's best to make sure your server's
[clock is synced](https://dayne.broderson.org/2020/03/12/the_time_is_now.html).)

The top level `zero_time` value is a
[Unix timestamp](https://www.unixtimestamp.com/) as a raw number
(eg. 1651893234.4 for 2022-05-06 8:13:54.4pm PT). Other time values in
the script are offsets from this value. If `zero_time` is 0.0, other
timestamps are absolute Unix times. If not set, `zero_time` defaults to the
time when the server was started.

## Time-variable values

Many values in pivid scripts (marked with `ğ‘“(ğ‘¡)` in the syntax above)
may change with time. This is how all non-static content is described,
including basic video playback (a time-varying `play` position).

This JSON format is the most general form of a time-variable value:

```yaml
â¸¨
  Â«constant value for all timeÂ»
â•‘
  {
    "segments": [
      {
        ğŸ”½
        ğŸ”˜ "t": [Â«segment begin timestampÂ», Â«segment end timestampÂ»],
        ğŸ”˜ â“ "t": Â«segment begin timestampÂ»,
           â“ "length": Â«segment length in secondsÂ»,
        ğŸ”¼

        ğŸ”½
        ğŸ”˜ "v": [Â«value at beginÂ», Â«control pointÂ», Â«control pointÂ», Â«value at endÂ»],
        ğŸ”˜ "v": [Â«value at beginÂ», Â«value at endÂ»],
        ğŸ”˜ "v": Â«value at beginÂ», "rate": Â«value change in units per secondÂ»,
        ğŸ”˜ "v": Â«constant value across segmentÂ»,
        ğŸ”¼
      },
      Â·Â·Â·
    ],

    â“ "repeat": â–¶ï¸ ğŸ”˜ Â«loop periodÂ» ğŸ”˜ true â—€ï¸
  }
â¸©
```

The function is [defined piecewise](https://en.wikipedia.org/wiki/Piecewise)
as a collection of segments with begin and end times. Segments must be
listed in time order and may not overlap. Before, between, and after defined
segments, the value is undefined and reverts to its default.

Within each section, the value is described by a 1-dimensional
[cubic BÃ©zier curve](https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B%C3%A9zier_curves).
(Constants and linear ramps are special cases of cubic BÃ©zier.) In the general
case, the Bezier is given by the value at the ends of the segment, plus
control points at 1/3 and 2/3 from begin to end.

If `"repeat"` is set to a number, the sequence restarts that long after the
first segment began, and repeats infinitely with the given period.

The format may be modified or simplified in various ways:
* Omit the end timestamp, specify `"length"` instead
* Omit both the end timestamp and length; the segment will continue to infinity
* Omit both timestamps, but specify `"length"`; the segment will start at zero time
* Omit both timestamps and length, the segment will extend from zero to infinity
* Omit the control point values; the segment will be a linear ramp
* Omit control points and end value, specify `"rate"` instead
* Omit control points, end value, and rate; the value will be constant over the segment
* Set `"repeat"' to `true`; looping will begin at the end of the last segment
* Replace outer JSON with a single segment definition
* Replace outer JSON with a single number; the value will be constant for all time

Next: [Development notes and links](notes.md)
